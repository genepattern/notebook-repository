{% extends "page.html" %}

{% block meta %}
    <meta http-equiv="refresh" content="60">
{% endblock %}

{% block main %}
    {% set named_spawners = user.all_spawners(include_default=False)|list %}

    <div class="container">
        <div id="messages"></div>
        <h1>Notebook Workspaces</h1>
        <p class="lead">Launch, create or share notebook workspaces.</p>
        <input type="search" id="nb-search" placeholder="Search Workspaces" class="form-control" />

        <div id="workspace">
            <div class="panel nb-workspace nb-workspace-new" data-api="{{ base_url }}api/users/{{ user.name }}/servers/" data-get="{{ base_url }}user/{{ user.name }}/">
                <div class="nb-img-top" style="background: rgba(0, 0, 0, 0.05) none repeat scroll 0% 0%;">
                    <i class="fa fa-plus-circle nb-workspace-icon"></i>
                </div>
                <div class="panel-body">
                    <h8 class="panel-title">New Workspace</h8>
                    <p class="panel-text">Create a New Notebook Workspace</p>
                </div>
            </div>

            {% for spawner in named_spawners %}

                <div class="panel nb-workspace {% if not spawner.active %}nb-stopped{% endif %}" data-name="{{ spawner.user_options['name'] or spawner.name }}" data-image="{{ spawner.user_options['image'] }}" data-description="{{ spawner.user_options['description'] }}" data-post="{{ base_url }}spawn/{{ user.name }}/{{ spawner.name }}" data-get="{{ user.server_url(spawner.name) }}" data-api="{{ base_url }}api/users/{{ user.name }}/servers/{{ spawner.name }}">
                    <div class="nb-icon-space hidden">
                        <i title="Shared" class="fa fa-share nb-shared-icon"></i>
                        <i title="Published" class="fa fa-newspaper-o nb-published-icon"></i>
                    </div>
                    <div class="dropdown nb-gear-menu">
                        <button type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="btn btn-default dropdown-toggle">
                            <i title="Options" class="fa fa-cog"></i>
                            <i title="Dropdown" class="caret"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a href="#" class="dropdown-item nb-edit">Edit</a></li>
                            <li class="hidden"><a href="#" class="dropdown-item nb-publish">Publish</a></li>
                            <li class="hidden"><a href="#" class="dropdown-item nb-share">Share</a></li>
                            <li><a href="#" class="dropdown-item nb-stop">Stop</a></li>
                            <li><a href="#" class="dropdown-item nb-delete">Delete</a></li>
                        </ul>
                    </div>
                    <img src="/static/images/background.jpg" alt="Project Icon" class="img-responsive nb-img-top">
                    <div class="panel-body">
                        <h8 class="panel-title">{{ spawner.user_options['name'] or spawner.name }}</h8>
                        <p class="panel-text">{{ spawner.user_options['description'] or spawner.last_activity }}</p>
                        <div class="panel-text nb-tags">
                            <span class="badge badge-secondary">{{ spawner.user_options['image'] or 'Unknown' }}</span>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    {% call modal('Delete Workspace', btn_class='btn-danger delete-button') %}
        <p>Are you sure that you want to delete this workspace?</p>
    {% endcall %}

    {% call modal('Create New Workspace', btn_class='btn-success create-button') %}
        <div class="form-horizontal">
            <div class="form-group">
                <label for="name" class="control-label col-sm-4">Workspace Name*</label>
                <div class="col-sm-8">
                    <input name="name" type="text" class="form-control" />
                </div>
            </div>
            <div class="form-group">
                <label for="image" class="control-label col-sm-4">Environment*</label>
                <div class="col-sm-8">
                    <select name="image" class="form-control">
                        {% for image in user.spawner.image_whitelist.keys() %}
                            <option value="{{ image }}">{{ image }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="description" class="control-label col-sm-4">Description</label>
                <div class="col-sm-8">
                    <input name="description" type="text" class="form-control" />
                </div>
            </div>
        </div>
    {% endcall %}

    {% call modal('Edit Workspace', btn_class='btn-warning edit-button') %}
        <div class="form-horizontal">
            <div class="form-group">
                <label for="name" class="control-label col-sm-4">Workspace Name*</label>
                <div class="col-sm-8">
                    <input name="name" type="text" class="form-control" />
                </div>
            </div>
            <div class="form-group">
                <label for="image" class="control-label col-sm-4">Environment*</label>
                <div class="col-sm-8">
                    <select name="image" class="form-control">
                        {% for image in user.spawner.image_whitelist.keys() %}
                            <option value="{{ image }}">{{ image }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="description" class="control-label col-sm-4">Description</label>
                <div class="col-sm-8">
                    <input name="description" type="text" class="form-control" />
                </div>
            </div>
        </div>
    {% endcall %}
{% endblock %}

{% block script %}
    {{ super() }}
    <script type="text/javascript">
        function new_workspace_dialog(workspace) {
            const create_dialog = $('#create-new-workspace-dialog');
            create_dialog.modal()
                .find(".create-button").off('click').one('click', () => {
                    // Get the form data
                    const api_url = workspace.data('api');
                    const get_url = workspace.data('get');
                    const workspace_name = create_dialog.find('[name=name]').val();
                    const safe_name = workspace_name.toLowerCase().replace(/[^A-Z0-9]+/ig, "_");
                    const image = create_dialog.find('[name=image]').val();
                    const description = create_dialog.find('[name=description]').val();

                    // Make the AJAX request
                    $.ajax({
                        method: 'POST',
                        url: api_url + safe_name,
                        contentType: 'application/json',
                        data: JSON.stringify({
                            "name": workspace_name,
                            "image": image,
                            "description": description
                        }),
                        success: () => {
                            // Open the workspace and refresh the page
                            window.open(get_url + safe_name);
                            window.location.reload();
                        },
                        error: () => $('#messages').append(
                            $('<div class="alert alert-danger">Unable to create workspace.</div>')
                        )
                    });
                });
        }

        // Edit workspace
        function edit_workspace(workspace) {
            console.log('called');
            const edit_dialog = $('#edit-workspace-dialog').modal();
            const workspace_name = edit_dialog.find('[name=name]').val($(workspace).data('name'));
            const image = edit_dialog.find('[name=image]').val($(workspace).data('image'));
            const description = edit_dialog.find('[name=description]').val($(workspace).data('description'));

            edit_dialog.find(".edit-button").off('click').one('click', () => {
                    // Prepare the form data
                    const api_url = workspace.data('api');
                    const get_url = workspace.data('get');

                    // Make the AJAX request
                    $.ajax({
                        method: 'POST',
                        url: api_url,
                        contentType: 'application/json',
                        data: JSON.stringify({
                            "name": workspace_name.val(),
                            "image": image.val(),
                            "description": description.val()
                        }),
                        success: () => window.location.reload(),
                        error: () => $('#messages').append(
                            $('<div class="alert alert-danger">Unable to edit workspace.</div>')
                        )
                    });
                });
        }

        // Stop workspace
        function stop_workspace(workspace) {
            const api_url = workspace.data('api');
            $.ajax({
                method: 'DELETE',
                url: api_url,
                contentType: 'application/json',
                data: '{ "remove": false }',
                success: () => workspace.addClass('nb-stopped'),
                error: () => $('#messages').append(
                    $('<div class="alert alert-danger">Unable to stop workspace.</div>')
                )
            });
        }

        // Delete workspace
        function delete_workspace(workspace) {
            $('#delete-workspace-dialog').modal()
                .find(".delete-button").off('click').one('click', () => {
                    // Make the call to delete the workspace
                    const api_url = workspace.data('api');
                    $.ajax({
                        method: 'DELETE',
                        url: api_url,
                        contentType: 'application/json',
                        data: '{ "remove": true }',
                        success: () => workspace.remove(),
                        error: () => $('#messages').append(
                            $('<div class="alert alert-danger">Unable to delete workspace.</div>')
                        )
                    });
                });
        }

        // Launch or open an existing workspace
        function open_workspace(workspace) {
            let running = !workspace.hasClass('nb-stopped');
            if (running) { // If running, just open a new tab
                const get_url = workspace.data('get');
                window.open(get_url);
            }
            else { // Otherwise, launch the server
                let image = workspace.data('image');
                const post_url = workspace.data('post');
                $(`<form action="${post_url}" method="POST" target="_blank" class="hidden"></form>`)
                    .append($(`<input name="image" type="hidden" value="${image}"/>`))
                    .appendTo('body')
                    .submit();
                workspace.removeClass('nb-stopped'); // Mark as running
            }
        }

        // Handle changes to the search box
        $('#nb-search').keyup((event) => {
            let search = $(event.target).val().trim().toLowerCase();

            // Display the matching projects
            const workspaces = $('#workspace').find('.nb-workspace');
            workspaces.each(function(i, workspace) {
                workspace = $(workspace);

                // Matching notebook
                if (workspace.text().toLowerCase().includes(search)) workspace.removeClass('hidden');

                // Not matching notebook
                else workspace.addClass('hidden');
            });
        });

        // Handle click events on workspaces
        $('.nb-workspace').click((event) => {
            // Ignore clicks on the gear menu
            if ($(event.target).closest('.dropdown').length) return;

            // If "New Workspace" is clicked
            if ($(event.currentTarget).hasClass('nb-workspace-new')) new_workspace_dialog($(event.currentTarget));

            // If any other workspace is clicked
            else open_workspace($(event.currentTarget));
        });

        // Handle menu clicks
        $('.nb-stop').click((event) => stop_workspace($(event.target).closest('.nb-workspace')));
        $('.nb-delete').click((event) => delete_workspace($(event.target).closest('.nb-workspace')));
        $('.nb-edit').click((event) => edit_workspace($(event.target).closest('.nb-workspace')));
    </script>
{% endblock %}