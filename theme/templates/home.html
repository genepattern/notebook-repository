{% extends "page.html" %}

{% block meta %}
    <meta http-equiv="refresh" content="300">
{% endblock %}

{% block main %}
    {% set named_spawners = user.all_spawners(include_default=False)|list %}

    <div class="container">
        <div id="messages">
            <div class="alert alert-success">
                <p><strong>Looking for your notebooks? They have been migrated to the project named Default Project.</strong></p>
                <p>The GenePattern Notebook Workspace now allows you to divide your work into multiple “projects,” each with its
                    own environment and extensions. For more information about notebook projects,
                    <a href="https://notebook.genepattern.org/basic-features/#notebook-projects" target="_blank">see our documentation</a>.</p>
            </div>
        </div>

        <div id="nb-header">
            <h1>Your Projects</h1>
            <p class="lead">Launch, create or edit notebook projects.</p>
            <input type="search" id="nb-search" placeholder="Search Projects" class="form-control" />
            <button id ="nb-new" class="btn btn-primary"><i class="fa fa-plus-circle"></i> New Project</button>
        </div>

        <div id="projects">
            {% for spawner in named_spawners %}

                <div class="panel nb-project {% if not spawner.active %}nb-stopped{% endif %}" data-name="{{ spawner.user_options['name'] or spawner.name }}" data-image="{{ spawner.user_options['image'] }}" data-description="{{ spawner.user_options['description'] }}" data-safename="{{ spawner.name }}" data-post="{{ base_url }}spawn/{{ user.name }}/{{ spawner.name }}" data-get="{{ user.server_url(spawner.name) }}" data-api="{{ base_url }}api/users/{{ user.name }}/servers/{{ spawner.name }}">
                    <div class="nb-icon-space hidden">
                        <i title="Shared" class="fa fa-share nb-shared-icon"></i>
                        <i title="Published" class="fa fa-newspaper-o nb-published-icon"></i>
                    </div>
                    <div class="dropdown nb-gear-menu">
                        <button type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="btn btn-default dropdown-toggle">
                            <i title="Options" class="fa fa-cog"></i>
                            <i title="Dropdown" class="caret"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a href="#" class="dropdown-item nb-edit">Edit</a></li>
                            <li class="hidden"><a href="#" class="dropdown-item nb-publish">Publish</a></li>
                            <li class="hidden"><a href="#" class="dropdown-item nb-share">Share</a></li>
                            <li><a href="#" class="dropdown-item nb-stop">Stop</a></li>
                            <li><a href="#" class="dropdown-item nb-delete">Delete</a></li>
                        </ul>
                    </div>
                    <img src="/static/images/background.jpg" alt="Project Icon" class="img-responsive nb-img-top">
                    <div class="panel-body">
                        <h8 class="panel-title">{{ spawner.user_options['name'] or spawner.name }}</h8>
                        <p class="panel-text">{{ spawner.user_options['description'] or spawner.last_activity }}</p>
                        <div class="panel-text nb-tags">
                            {# TODO: RE-ENABLE FOR RELEASE 2 #}
{#                            <span class="badge badge-secondary">{{ spawner.user_options['image'] or 'Unknown' }}</span>#}
                        </div>
                    </div>
                </div>
            {% endfor %}

            <div class="panel nb-project nb-project-new" data-api="{{ base_url }}api/users/{{ user.name }}/servers/" data-get="{{ base_url }}user/{{ user.name }}/">
                <div class="nb-img-top" style="background: rgba(0, 0, 0, 0.05) none repeat scroll 0% 0%;">
                    <i class="fa fa-plus-circle nb-project-icon"></i>
                </div>
                <div class="panel-body">
                    <h8 class="panel-title">New Project</h8>
                    <p class="panel-text">Create a New Notebook Project</p>
                </div>
            </div>
        </div>
    </div>

    <div id="repository-container" class="container">
        <h1>Public Notebooks</h1>
        <p class="lead">Browse, launch and reproduce public notebooks.</p>
    </div>

    {% call modal('Delete Project', btn_class='btn-danger delete-button') %}
        <p>Are you sure that you want to delete this project?</p>
    {% endcall %}

    {% call modal('Create New Project', btn_class='btn-success create-button') %}
        <div class="form-horizontal">
            <div class="form-group">
                <label for="name" class="control-label col-sm-4">Project Name*</label>
                <div class="col-sm-8">
                    <input name="name" type="text" class="form-control" />
                </div>
            </div>
            <input type="hidden" name="image" value="Legacy" />
            {# TODO: RE-ENABLE FOR RELEASE 2 #}
{#            <div class="form-group">#}
{#                <label for="image" class="control-label col-sm-4">Environment*</label>#}
{#                <div class="col-sm-8">#}
{#                    <select name="image" class="form-control">#}
{#                        {% for image in user.spawner.image_whitelist.keys() %}#}
{#                            <option value="{{ image }}">{{ image }}</option>#}
{#                        {% endfor %}#}
{#                    </select>#}
{#                </div>#}
{#            </div>#}
            <div class="form-group">
                <label for="description" class="control-label col-sm-4">Description</label>
                <div class="col-sm-8">
                    <input name="description" type="text" class="form-control" />
                </div>
            </div>
        </div>
    {% endcall %}

    {% call modal('Edit Project', btn_label='Save', btn_class='btn-warning edit-button') %}
        <div class="form-horizontal">
            <div class="form-group">
                <label for="name" class="control-label col-sm-4">Project Name*</label>
                <div class="col-sm-8">
                    <input name="name" type="text" class="form-control" />
                </div>
            </div>
            <input type="hidden" name="image" value="Legacy" />
            {# TODO: RE-ENABLE FOR RELEASE 2 #}
{#            <div class="form-group">#}
{#                <label for="image" class="control-label col-sm-4">Environment*</label>#}
{#                <div class="col-sm-8">#}
{#                    <select name="image" class="form-control">#}
{#                        {% for image in user.spawner.image_whitelist.keys() %}#}
{#                            <option value="{{ image }}">{{ image }}</option>#}
{#                        {% endfor %}#}
{#                    </select>#}
{#                </div>#}
{#            </div>#}
            <div class="form-group">
                <label for="description" class="control-label col-sm-4">Description</label>
                <div class="col-sm-8">
                    <input name="description" type="text" class="form-control" />
                </div>
            </div>
        </div>
    {% endcall %}

    {% call modal('Welcome to GenePattern Notebook') %}
        <p class="lead text-center">Initializing your environment.<br/>Don't worry, this is a one time thing.</p>
        <p class="text-center"><i class="fa fa-spinner fa-spin fa-3x fa-fw repo-modal-spinner"></i></p>
    {% endcall %}
{% endblock %}

{% block script %}
    {{ super() }}
    <script type="text/javascript">
        const username = "{{ user.name }}";

        function project_exists(project_name) {
            const project_nodes = $("#projects > .nb-project");
            let found_name = false;
            project_nodes.each((i, e) => {
                const safe_name = $(e).data('safename');
                if (project_name === safe_name) {
                    found_name = true;
                    return false;
                }
            });
            return found_name;
        }

        function init_legacy() {
            if (!project_exists('legacy_project')) {
                const create_dialog = $('#welcome-to-genepattern-notebook-dialog');
                create_dialog.modal().find('button').hide();

                // Make the AJAX request
                $.ajax({
                    method: 'POST',
                    url: "{{ base_url }}api/users/{{ user.name }}/servers/legacy_project",
                    contentType: 'application/json',
                    data: JSON.stringify({
                        "name": "Default Project",
                        "image": "Legacy",
                        "description": "Click here to access your previous notebooks."
                    }),
                    success: () => {
                        window.location.reload();
                    }
                });
            }
        }

        function new_project_dialog(project) {
            const create_dialog = $('#create-new-project-dialog');
            create_dialog.modal()
                .find(".create-button").off('click').one('click', () => {
                    // Get the form data
                    const api_url = project.data('api');
                    const get_url = project.data('get');
                    const project_name = create_dialog.find('[name=name]').val();
                    const safe_name = project_name.toLowerCase().replace(/[^A-Z0-9]+/ig, "_");
                    const image = create_dialog.find('[name=image]').val();
                    const description = create_dialog.find('[name=description]').val();

                    // Make sure there isn't already a project named this
                    if (project_exists(safe_name)) {
                        $('#messages').append(
                            $('<div class="alert alert-danger">Please choose a different name. A project already exists with that name.</div>')
                        );
                        return;
                    }

                    // Make the AJAX request
                    $.ajax({
                        method: 'POST',
                        url: api_url + safe_name,
                        contentType: 'application/json',
                        data: JSON.stringify({
                            "name": project_name,
                            "image": image,
                            "description": description
                        }),
                        success: () => {
                            // Open the project and refresh the page
                            window.open(get_url + safe_name);
                            window.location.reload();
                        },
                        error: () => $('#messages').append(
                            $('<div class="alert alert-danger">Unable to create project.</div>')
                        )
                    });
                });
        }

        // Edit project
        function edit_project(project) {
            const edit_dialog = $('#edit-project-dialog').modal();
            const project_name = edit_dialog.find('[name=name]').val($(project).data('name'));
            const image = edit_dialog.find('[name=image]').val($(project).data('image'));
            const description = edit_dialog.find('[name=description]').val($(project).data('description'));

            edit_dialog.find(".edit-button").off('click').one('click', () => {
                    // Prepare the form data
                    const api_url = project.data('api');
                    const get_url = project.data('get');

                    // Make the AJAX request
                    $.ajax({
                        method: 'POST',
                        url: api_url,
                        contentType: 'application/json',
                        data: JSON.stringify({
                            "name": project_name.val(),
                            "image": image.val(),
                            "description": description.val()
                        }),
                        success: () => window.location.reload(),
                        error: () => $('#messages').append(
                            $('<div class="alert alert-danger">Unable to edit project.</div>')
                        )
                    });
                });
        }

        // Stop project
        function stop_project(project) {
            const api_url = project.data('api');
            $.ajax({
                method: 'DELETE',
                url: api_url,
                contentType: 'application/json',
                data: '{ "remove": false }',
                success: () => project.addClass('nb-stopped'),
                error: () => $('#messages').append(
                    $('<div class="alert alert-danger">Unable to stop project.</div>')
                )
            });
        }

        // Delete project
        function delete_project(project) {
            {# Remove check in Release 2 #}
            const safename = project.data('safename');
            if (safename === 'legacy_project') {
                $('#messages').append(
                    $('<div class="alert alert-danger">Sorry. You cannot delete the default project.</div>')
                );
                return;
            }

            $('#delete-project-dialog').modal()
                .find(".delete-button").off('click').one('click', () => {
                    // Make the call to delete the project
                    const api_url = project.data('api');
                    $.ajax({
                        method: 'DELETE',
                        url: api_url,
                        contentType: 'application/json',
                        data: '{ "remove": true }',
                        success: () => project.remove(),
                        error: () => $('#messages').append(
                            $('<div class="alert alert-danger">Unable to delete project.</div>')
                        )
                    });
                });
        }

        // Launch or open an existing project
        function open_project(project, callback) {
            // If a custom callback is not defined, use the default one
            const get_url = project.data('get');
            if (!callback) callback = () => {
                // Open the project in a new tab
                window.open(get_url);
            };

            let running = !project.hasClass('nb-stopped');
            if (running) { // If running, just open a new tab
                callback(project);
            }
            else { // Otherwise, launch the server
                let image = project.data('image');
                let name = project.data('name');
                let description = project.data('description');
                const api_url = project.data('api');
                const get_url = project.data('get');

                // Make the AJAX request
                $.ajax({
                    method: 'POST',
                    url: api_url,
                    contentType: 'application/json',
                    data: JSON.stringify({
                        "name": name,
                        "image": image,
                        "description": description
                    }),
                    success: () => {},
                    error: () => $('#messages').append(
                        $('<div class="alert alert-danger">Unable to edit project.</div>')
                    )
                });

                callback(project);

                // Older implementation using the POST URL, for some reason wouldn't preserve name & description, remove when no longer needed
                {#$(`<form action="${post_url}" method="POST" target="_blank" class="hidden"></form>`)#}
                {#    .append($(`<input name="image" type="hidden" value="${image}"/>`))#}
                {#    .append($(`<input name="name" type="hidden" value="${name}"/>`))#}
                {#    .append($(`<input name="description" type="hidden" value="${description}"/>`))#}
                {#    .appendTo('body')#}
                {#    .submit();#}

                project.removeClass('nb-stopped'); // Mark as running
            }
        }

        // Sort the projects
        const projects_div = $("#projects");
        const project_nodes = projects_div.find(".nb-project");
        const sort_projects = Array.prototype.sort.bind(project_nodes);
        sort_projects(function (a, b) {
            // Ensure that "New Project" is listed last
            const a_is_new = $(a).hasClass('nb-project-new');
            const b_is_new = $(b).hasClass('nb-project-new');
            if (a_is_new) return 1;
            if (b_is_new) return -1;

            // Basic case-insensitive alphanumeric sorting
            const a_text = $(a).find('.panel-title').text().toLowerCase();
            const b_text = $(b).find('.panel-title').text().toLowerCase();
            if ( a_text < b_text ) return -1;
            if ( a_text > b_text ) return 1;
            return 0;
        });
        projects_div.append(project_nodes);

        // Handle changes to the search box
        $('#nb-search').keyup((event) => {
            let search = $(event.target).val().trim().toLowerCase();

            // Display the matching projects
            const projects = $('#projects').find('.nb-project');
            projects.each(function(i, project) {
                project = $(project);

                // Matching notebook
                if (project.text().toLowerCase().includes(search)) project.removeClass('hidden');

                // Not matching notebook
                else project.addClass('hidden');
            });
        });

        // Handle click events on projects
        $('.nb-project').click((event) => {
            // Ignore clicks on the gear menu
            if ($(event.target).closest('.dropdown').length) return;

            // If "New Project" is clicked
            if ($(event.currentTarget).hasClass('nb-project-new')) new_project_dialog($(event.currentTarget));

            // If any other project is clicked
            else open_project($(event.currentTarget));
        });

        // Handle new project button click
        $('#nb-new').click(() => {
            new_project_dialog($(".nb-project-new"));
        });

        // Handle menu clicks
        $('.nb-stop').click((event) => stop_project($(event.target).closest('.nb-project')));
        $('.nb-delete').click((event) => delete_project($(event.target).closest('.nb-project')));
        $('.nb-edit').click((event) => edit_project($(event.target).closest('.nb-project')));

        {# TODO: Remove in Release 2  #}
        // Initialize the legacy_project if necessary
        init_legacy();
    </script>

    {# TODO: Replace with new functionality for Release 2  #}
    <script type="text/javascript" src="/hub/static/js/library.js"></script>
    <script type="text/javascript">
        requirejs(["library"], function(library) {
            library.tree_init();
        });
    </script>
{% endblock %}